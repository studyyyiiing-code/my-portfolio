/**
 * main.js
 * ì „ì—­ ì„¤ì •: ë‹¤í¬ëª¨ë“œ, ëª¨ë°”ì¼ ë©”ë‰´, ê·¸ë¦¬ê³  'ê´€ë¦¬ì ìˆ˜ì • ëª¨ë“œ'
 */

document.addEventListener('componentsLoaded', () => {
    initTheme();
    initMobileMenu();
    highlightActiveLink();
    initEditMode(); // ìˆ˜ì • ëª¨ë“œ ì´ˆê¸°í™”
});

// 1. ë‹¤í¬ ëª¨ë“œ ì´ˆê¸°í™” ë° í† ê¸€
function initTheme() {
    const themeToggleBtn = document.getElementById('theme-toggle');
    const icon = themeToggleBtn ? themeToggleBtn.querySelector('i') : null;
    
    if (!themeToggleBtn) return;

    const savedTheme = localStorage.getItem('theme');
    const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    
    if (savedTheme === 'dark' || (!savedTheme && systemPrefersDark)) {
        document.body.setAttribute('data-theme', 'dark');
        if(icon) { icon.classList.remove('fa-moon'); icon.classList.add('fa-sun'); }
    }

    themeToggleBtn.addEventListener('click', () => {
        const currentTheme = document.body.getAttribute('data-theme');
        if (currentTheme === 'dark') {
            document.body.setAttribute('data-theme', 'light');
            localStorage.setItem('theme', 'light');
            if(icon) { icon.classList.remove('fa-sun'); icon.classList.add('fa-moon'); }
        } else {
            document.body.setAttribute('data-theme', 'dark');
            localStorage.setItem('theme', 'dark');
            if(icon) { icon.classList.remove('fa-moon'); icon.classList.add('fa-sun'); }
        }
    });
}

// 2. ëª¨ë°”ì¼ ë©”ë‰´ í† ê¸€
function initMobileMenu() {
    const mobileMenuBtn = document.getElementById('mobile-menu-btn');
    const navLinks = document.getElementById('nav-links');

    if (mobileMenuBtn && navLinks) {
        mobileMenuBtn.addEventListener('click', () => {
            navLinks.classList.toggle('active');
            const icon = mobileMenuBtn.querySelector('i');
            if (navLinks.classList.contains('active')) {
                icon.classList.remove('fa-bars');
                icon.classList.add('fa-times');
            } else {
                icon.classList.remove('fa-times');
                icon.classList.add('fa-bars');
            }
        });
    }
}

// 3. í˜„ì¬ í˜ì´ì§€ ë„¤ë¹„ê²Œì´ì…˜ í•˜ì´ë¼ì´íŠ¸
function highlightActiveLink() {
    const currentPath = window.location.pathname;
    const links = document.querySelectorAll('.nav-links a');
    
    links.forEach(link => {
        const href = link.getAttribute('href');
        if (currentPath.includes(href) || (currentPath.endsWith('/') && href === 'index.html')) {
            link.classList.add('active-link');
            // ìŠ¤íƒ€ì¼ì€ CSSì—ì„œ ì œì–´í•˜ê±°ë‚˜ ì—¬ê¸°ì„œ ì§ì ‘ ì£¼ì…
            link.style.color = 'var(--primary-color)';
            link.style.fontWeight = '700';
        }
    });
}

// ==========================================
// 4. â­ [í•µì‹¬ ê¸°ëŠ¥] ê´€ë¦¬ì ìˆ˜ì • ëª¨ë“œ (Edit Mode)
// ==========================================
function initEditMode() {
    // í¸ì§‘ ëª¨ë“œ ìƒíƒœ í‘œì‹œê¸° ìƒì„±
    const indicator = document.createElement('div');
    indicator.id = 'edit-mode-indicator';
    indicator.innerHTML = '<i class="fas fa-pen"></i> í¸ì§‘ ëª¨ë“œ ON <br><small style="font-weight:400; font-size:0.8rem;">(ì €ì¥í•˜ë ¤ë©´ F8)</small>';
    document.body.appendChild(indicator);

    let isEditing = false;

    // F9 í‚¤: í¸ì§‘ ëª¨ë“œ í† ê¸€
    // F8 í‚¤: í˜„ì¬ HTML ë‹¤ìš´ë¡œë“œ (ì €ì¥ ì‹œë®¬ë ˆì´ì…˜)
    document.addEventListener('keydown', (e) => {
        
        // F9: í¸ì§‘ ëª¨ë“œ ì¼œê¸°/ë„ê¸°
        if (e.key === 'F9') {
            isEditing = !isEditing;
            document.body.contentEditable = isEditing;
            document.designMode = isEditing ? 'on' : 'off';
            
            if (isEditing) {
                indicator.style.display = 'block';
                alert('âœï¸ [í¸ì§‘ ëª¨ë“œ ì‹œì‘]\ní…ìŠ¤íŠ¸ì™€ ì´ë¯¸ì§€ë¥¼ í´ë¦­í•´ì„œ ìˆ˜ì •í•˜ì„¸ìš”.\n\nì£¼ì˜: ìƒˆë¡œê³ ì¹¨í•˜ë©´ ì‚¬ë¼ì§‘ë‹ˆë‹¤.\nì €ì¥í•˜ë ¤ë©´ F8ì„ ëˆ„ë¥´ì„¸ìš”.');
            } else {
                indicator.style.display = 'none';
            }
        }

        // F8: ë³€ê²½ëœ HTML ë‹¤ìš´ë¡œë“œ
        if (e.key === 'F8' && isEditing) {
            e.preventDefault();
            downloadHTML();
        }
    });
}

// HTML íŒŒì¼ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
function downloadHTML() {
    // 1. í¸ì§‘ ëª¨ë“œ UI ìˆ¨ê¸°ê¸° (ì €ì¥ íŒŒì¼ì— í¬í•¨ë˜ì§€ ì•Šê²Œ)
    const indicator = document.getElementById('edit-mode-indicator');
    if(indicator) indicator.remove();
    document.body.contentEditable = 'false';

    // 2. í˜„ì¬ HTML ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
    const htmlContent = `<!DOCTYPE html>\n<html lang="ko">\n${document.documentElement.innerHTML}\n</html>`;

    // 3. Blob ìƒì„± ë° ë‹¤ìš´ë¡œë“œ ë§í¬ íŠ¸ë¦¬ê±°
    const blob = new Blob([htmlContent], { type: 'text/html' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    
    // í˜„ì¬ íŒŒì¼ëª…ìœ¼ë¡œ ì €ì¥ (ì˜ˆ: index.html)
    let fileName = window.location.pathname.split('/').pop();
    if (!fileName) fileName = 'index.html';
    
    a.download = fileName;
    a.click();

    // 4. UI ë³µêµ¬
    document.body.appendChild(indicator);
    document.body.contentEditable = 'true';
    alert(`ğŸ’¾ ${fileName} íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œ ë˜ì—ˆìŠµë‹ˆë‹¤.\n\në‹¤ìš´ë¡œë“œëœ íŒŒì¼ì„ í”„ë¡œì íŠ¸ í´ë”ì— ë®ì–´ì“°ë©´ ì˜êµ¬ì ìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤.`);
}
